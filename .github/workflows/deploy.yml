name: Deploy Football3D

on:
  push:
    branches:
      - main  # Se ejecuta cada vez que subes cambios a main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Descargar cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ” Configurar SSH
        run: |
          mkdir -p ~/.ssh/
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: ðŸ“¦ Sincronizar archivos (Rsync)
        run: |
          rsync -avz --delete \
            -e "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" \
            --exclude 'node_modules' \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'build' \
            --exclude '.env.local' \
            ./ ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/opt/football3d/

      - name: ðŸ³ Reconstruir Docker en VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd /opt/football3d
            
            echo "ðŸ›‘ Deteniendo contenedores antiguos..."
            docker stop football3d_frontend_1 football3d_game-server_1 2>/dev/null || true
            docker rm football3d_frontend_1 football3d_game-server_1 2>/dev/null || true
            
            echo "ðŸ—ï¸ Levantando nuevos contenedores..."
            # LÃ³gica para detectar versiÃ³n de Docker
            if docker compose version >/dev/null 2>&1; then
                docker compose build --no-cache
                docker compose up -d
            else
                docker-compose build --no-cache
                docker-compose up -d
            fi
            
            echo "ðŸ§¹ Limpiando imÃ¡genes basura..."
            docker image prune -f

